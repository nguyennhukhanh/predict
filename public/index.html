<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Price Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
      .chart-container {
        min-height: 400px;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-8">Crypto Price Predictor</h1>

      <!-- Form Controls -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div>
          <label class="block text-sm font-medium mb-2">Symbol</label>
          <input
            type="text"
            id="symbol"
            value="BTCUSDT"
            class="w-full p-2 rounded bg-gray-800 border border-gray-700"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Interval</label>
          <select
            id="interval"
            class="w-full p-2 rounded bg-gray-800 border border-gray-700"
          >
            <option value="1m">1 minute</option>
            <option value="3m">3 minutes</option>
            <option value="5m">5 minutes</option>
            <option value="15m">15 minutes</option>
            <option value="30m">30 minutes</option>
            <option value="1h" selected>1 hour</option>
            <option value="2h">2 hours</option>
            <option value="4h">4 hours</option>
            <option value="6h">6 hours</option>
            <option value="8h">8 hours</option>
            <option value="12h">12 hours</option>
            <option value="1d">1 day</option>
            <option value="3d">3 days</option>
            <option value="1w">1 week</option>
            <option value="1M">1 month</option>
          </select>
        </div>
        <div class="flex items-end">
          <button
            id="predict"
            class="w-full p-2 bg-blue-600 rounded hover:bg-blue-700"
          >
            Predict
          </button>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-gray-800 p-4 rounded-lg">
          <h2 class="text-xl font-semibold mb-4">Price Analysis</h2>
          <div id="priceChart" class="chart-container"></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <h2 class="text-xl font-semibold mb-4">Technical Indicators</h2>
          <div id="indicatorChart" class="chart-container"></div>
        </div>
      </div>

      <!-- Advanced Analytics -->
      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-gray-800 p-4 rounded-lg">
          <h2 class="text-xl font-semibold mb-4">Market Analysis</h2>
          <div id="marketData" class="grid grid-cols-2 gap-4">
            <!-- Market data will be inserted here -->
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <h2 class="text-xl font-semibold mb-4">Technical Analysis</h2>
          <div id="technicalData" class="grid grid-cols-2 gap-4">
            <!-- Technical data will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Prediction Results -->
      <div id="results" class="mt-8 bg-gray-800 p-4 rounded-lg">
        <h2 class="text-xl font-semibold mb-4">Prediction Results</h2>
        <div id="predictionData" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Results will be inserted here -->
        </div>
      </div>
    </div>

    <script>
      let priceChart, indicatorChart;

      // Initialize charts
      function initCharts() {
        const chartOptions = {
          chart: {
            type: "line",
            animations: {
              enabled: false,
            },
            foreColor: "#fff",
            background: "transparent",
            toolbar: {
              show: true,
              tools: {
                download: true,
                selection: true,
                zoom: true,
                zoomin: true,
                zoomout: true,
                pan: true,
                reset: true,
              },
            },
          },
          stroke: {
            curve: "smooth",
            width: 2,
          },
          grid: {
            borderColor: "#404040",
          },
          tooltip: {
            theme: "dark",
            x: {
              format: "dd MMM yyyy HH:mm",
            },
          },
          xaxis: {
            type: "datetime",
            labels: {
              datetimeUTC: false,
            },
          },
          yaxis: {
            labels: {
              formatter: (value) => formatNumber(value),
            },
          },
        };

        priceChart = new ApexCharts(document.querySelector("#priceChart"), {
          ...chartOptions,
          series: [
            {
              name: "Price",
              data: [],
            },
            {
              name: "Predicted",
              data: [],
            },
          ],
        });

        indicatorChart = new ApexCharts(
          document.querySelector("#indicatorChart"),
          {
            ...chartOptions,
            series: [
              {
                name: "RSI",
                data: [],
              },
              {
                name: "Momentum",
                data: [],
              },
              {
                name: "Volatility",
                data: [],
              },
            ],
          }
        );

        priceChart.render();
        indicatorChart.render();
      }

      function updateCharts(data) {
        try {
          // Format giá thành mảng dữ liệu cho biểu đồ
          const priceData = data.timestamps.map((timestamp, i) => ({
            x: new Date(Number(timestamp)),
            y: Number(data.prices[i]), // Sử dụng mảng prices thay vì giá đơn lẻ
          }));

          // Tính toán điểm cuối cho đường dự đoán
          const lastPoint = priceData[priceData.length - 1];
          const predictionPoints = [
            lastPoint,
            {
              x: new Date(lastPoint.x.getTime() + 3600000), // 1 giờ sau
              y: Number(data.predictedPrice),
            },
          ];

          // Cập nhật biểu đồ giá
          priceChart.updateOptions({
            chart: {
              height: 400,
              animations: {
                enabled: false,
              },
            },
            stroke: {
              width: [2, 2],
              dashArray: [0, 5],
            },
            colors: ["#00E396", "#FEB019"],
            xaxis: {
              type: "datetime",
              labels: {
                datetimeUTC: false,
                style: {
                  colors: "#fff",
                },
              },
            },
            yaxis: {
              labels: {
                style: {
                  colors: "#fff",
                },
                formatter: (value) => formatNumber(value, data.symbol),
              },
              tickAmount: 6,
            },
            tooltip: {
              theme: "dark",
              x: {
                format: "dd MMM yyyy HH:mm",
              },
            },
            grid: {
              borderColor: "#90A4AE30",
              row: {
                colors: ["transparent", "transparent"],
              },
            },
            legend: {
              labels: {
                colors: "#fff",
              },
            },
          });

          priceChart.updateSeries([
            {
              name: "Historical Price",
              data: priceData,
            },
            {
              name: "Prediction",
              data: predictionPoints,
            },
          ]);

          // Cập nhật biểu đồ chỉ báo kỹ thuật
          const technicalData = data.timestamps
            .slice(-30)
            .map((timestamp, i) => ({
              x: new Date(Number(timestamp)),
              RSI: data.analytics.technical.rsi,
              Momentum: data.analytics.momentum,
              Trend: data.analytics.trend,
            }));

          indicatorChart.updateOptions({
            chart: {
              height: 400,
              animations: {
                enabled: false,
              },
            },
            stroke: {
              width: [2, 2, 2],
              curve: "smooth",
            },
            colors: ["#00E396", "#008FFB", "#FEB019"],
            xaxis: {
              type: "datetime",
              labels: {
                datetimeUTC: false,
                style: {
                  colors: "#fff",
                },
              },
            },
            yaxis: [
              {
                title: {
                  text: "RSI",
                  style: {
                    color: "#00E396",
                  },
                },
                min: 0,
                max: 100,
                labels: {
                  style: {
                    colors: "#fff",
                  },
                },
              },
              {
                title: {
                  text: "Momentum/Trend",
                  style: {
                    color: "#008FFB",
                  },
                },
                min: -100,
                max: 100,
                opposite: true,
                labels: {
                  style: {
                    colors: "#fff",
                  },
                },
              },
            ],
            tooltip: {
              theme: "dark",
              x: {
                format: "dd MMM yyyy HH:mm",
              },
            },
            grid: {
              borderColor: "#90A4AE30",
            },
            legend: {
              labels: {
                colors: "#fff",
              },
            },
          });

          indicatorChart.updateSeries([
            {
              name: "RSI",
              type: "line",
              data: technicalData.map((d) => ({
                x: d.x,
                y: d.RSI,
              })),
            },
            {
              name: "Momentum",
              type: "line",
              data: technicalData.map((d) => ({
                x: d.x,
                y: d.Momentum,
              })),
            },
            {
              name: "Trend",
              type: "line",
              data: technicalData.map((d) => ({
                x: d.x,
                y: d.Trend,
              })),
            },
          ]);
        } catch (error) {
          console.error("Error updating charts:", error);
        }
      }

      function formatNumber(num, symbol) {
        if (!num) return "0";

        // Xử lý hiển thị theo loại coin
        if (symbol.includes("SHIB") || symbol.includes("DOGE") || num < 0.01) {
          return num.toPrecision(8);
        } else if (num < 1) {
          return num.toPrecision(6);
        } else if (num < 100) {
          return num.toPrecision(8);
        } else {
          return num.toPrecision(10);
        }
      }

      function updateAnalytics(data) {
        // Update market analysis
        document.getElementById("marketData").innerHTML = `
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">Current Price</div>
                    <div class="text-lg">${formatNumber(
                      data.currentPrice,
                      data.symbol
                    )}</div>
                </div>
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">Predicted Price</div>
                    <div class="text-lg">${formatNumber(
                      data.predictedPrice,
                      data.symbol
                    )}</div>
                </div>
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">Market Pattern</div>
                    <div class="text-md">${data.pattern}</div>
                </div>
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">Trend</div>
                    <div class="text-md">${data.trend}</div>
                </div>
            `;

        // Update technical analysis
        document.getElementById("technicalData").innerHTML = `
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">RSI</div>
                    <div class="text-lg">${data.analytics.technical.rsi.toFixed(
                      2
                    )}</div>
                </div>
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">Momentum</div>
                    <div class="text-lg">${data.analytics.momentum.toFixed(
                      2
                    )}%</div>
                </div>
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">Volatility</div>
                    <div class="text-lg">${data.analytics.volatility.toFixed(
                      2
                    )}%</div>
                </div>
                <div class="p-4 bg-gray-700 rounded">
                    <div class="text-sm text-gray-400">Confidence</div>
                    <div class="text-lg">${data.confidence.toFixed(2)}%</div>
                </div>
            `;

        // Update prediction results
        document.getElementById("predictionData").innerHTML = `
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Price Movement</div>
              <div class="text-lg ${
                data.predictedPrice > data.currentPrice
                  ? "text-green-400"
                  : "text-red-400"
              }">
                  ${(
                    ((data.predictedPrice - data.currentPrice) /
                      data.currentPrice) *
                    100
                  ).toFixed(2)}%
              </div>
              <div class="text-xs text-gray-500">Expected Change</div>
          </div>
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Confidence Score</div>
              <div class="text-lg">${data.confidence.toFixed(2)}%</div>
              <div class="text-xs text-gray-500">Prediction Accuracy</div>
          </div>
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Time Frame</div>
              <div class="text-lg">${
                document.getElementById("interval").value
              }</div>
              <div class="text-xs text-gray-500">Analysis Period</div>
          </div>
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Risk Level</div>
              <div class="text-lg">
                  ${
                    data.analytics.volatility > 50
                      ? "High"
                      : data.analytics.volatility > 30
                      ? "Medium"
                      : "Low"
                  }
              </div>
              <div class="text-xs text-gray-500">Based on Volatility</div>
          </div>
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Signal Strength</div>
              <div class="text-lg">${data.score.toFixed(2)}%</div>
              <div class="text-xs text-gray-500">Trading Signal</div>
          </div>
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Volume Profile</div>
              <div class="text-lg">${data.analytics.pattern.strength.toFixed(
                2
              )}%</div>
              <div class="text-xs text-gray-500">Market Participation</div>
          </div>
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Market Sentiment</div>
              <div class="text-lg ${
                data.trend.includes("BULLISH")
                  ? "text-green-400"
                  : data.trend.includes("BEARISH")
                  ? "text-red-400"
                  : "text-yellow-400"
              }">
                  ${data.trend}
              </div>
              <div class="text-xs text-gray-500">Overall Direction</div>
          </div>
          <div class="p-4 bg-gray-700 rounded">
              <div class="text-sm text-gray-400">Pattern Recognition</div>
              <div class="text-lg">${data.pattern}</div>
              <div class="text-xs text-gray-500">Market Structure</div>
          </div>
        `;

        // Highlight significant changes
        const priceChange =
          ((data.predictedPrice - data.currentPrice) / data.currentPrice) * 100;
        if (Math.abs(priceChange) > 5) {
          document
            .getElementById("predictionData")
            .firstElementChild.classList.add("animate-pulse");
        }
      }

      async function updatePrediction() {
        const symbol = document.getElementById("symbol").value;
        const interval = document.getElementById("interval").value;

        try {
          const response = await fetch(
            `/api/predict?symbol=${symbol}&interval=${interval}`
          );
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          updateCharts(data);
          updateAnalytics(data);
        } catch (error) {
          console.error("Prediction error:", error);
          alert("Error getting prediction: " + error.message);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        initCharts();
        document
          .getElementById("predict")
          .addEventListener("click", updatePrediction);
        updatePrediction(); // Initial prediction
      });
    </script>
  </body>
</html>
